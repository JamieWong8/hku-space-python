<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deal Scout (Static UI) â€¢ GitHub Pages</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style> body { background:#f7f9fc } .container-narrow { max-width: 1100px; margin: 24px auto; } </style>
</head>
<body>
  <div class="container-narrow">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">Deal Scout (Static UI)</h3>
      <div>
        <span class="text-muted me-2">API:</span>
        <code id="apiBaseDisplay"></code>
      </div>
    </div>

    <div class="alert alert-info py-2">
      This is a static UI deployed on GitHub Pages. It calls your running backend API for data.
      Configure API base with the API_BASE query string, e.g. <code>?API_BASE=http://localhost:5000</code>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Industry Group</label>
            <select class="form-select" id="industryFilter"><option value="">All Industry Groups</option></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Region</label>
            <select class="form-select" id="regionFilter"><option value="">All Regions</option></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Investment Tier</label>
            <select class="form-select" id="tierFilter">
              <option value="">All Tiers</option>
              <option value="tier1">ðŸŸ¢ Tier 1 (Strong Buy)</option>
              <option value="tier2">ðŸŸ¡ Tier 2 (Buy)</option>
              <option value="tier3">ðŸŸ  Tier 3 (Monitor)</option>
              <option value="avoid">ðŸ”´ Tier 4 (Avoid)</option>
            </select>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button id="searchBtn" class="btn btn-primary w-100"><i class="fas fa-search"></i></button>
          </div>
        </div>
      </div>
    </div>

    <div id="companiesList" class="row g-3">
      <div class="col-12 text-center">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2">Loading companies...</p>
      </div>
    </div>

    <div class="d-flex justify-content-center mt-3">
      <ul class="pagination" id="companyPagination"></ul>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    // Read API base from query (?API_BASE=...) or default to relative
  const params = new URLSearchParams(location.search);
  const API_BASE = params.get('API_BASE') || (typeof STATIC_API_BASE !== 'undefined' ? STATIC_API_BASE : '');
    document.getElementById('apiBaseDisplay').textContent = API_BASE || '(relative)';

    let hasRegions = false; let hasGroupedIndustry = false; let currentPage = 1; let currentFilters = {}; let inflight;

    function apiUrl(path, query={}) {
      const q = new URLSearchParams(query).toString();
      const base = API_BASE.replace(/\/$/, '');
      return `${base}${path}${q ? ('?' + q) : ''}`;
    }

    function updateFiltersUI(filters) {
      const indSel = document.getElementById('industryFilter');
      const regSel = document.getElementById('regionFilter');
      const inds = Array.isArray(filters.industry_groups) && filters.industry_groups.length ? (hasGroupedIndustry = true, filters.industry_groups) : (filters.industries || []);
      const regs = Array.isArray(filters.regions) && filters.regions.length ? (hasRegions = true, filters.regions) : (filters.locations || []);

      indSel.innerHTML = `<option value="">${hasGroupedIndustry ? 'All Industry Groups' : 'All Industries'}</option>` + inds.map(x=>`<option value="${x}">${x}</option>`).join('');
      regSel.innerHTML = `<option value="">${hasRegions ? 'All Regions' : 'All Locations'}</option>` + regs.map(x=>`<option value="${x}">${x}</option>`).join('');
    }

    function updatePagination(p) {
      const ul = document.getElementById('companyPagination');
      if (!p || p.total_pages <= 1) { ul.innerHTML=''; return; }
      let html = '';
      if (p.page > 1) html += `<li class="page-item"><a class="page-link" href="#" data-page="${p.page-1}">Previous</a></li>`;
      const start = Math.max(1, p.page-2), end = Math.min(p.total_pages, p.page+2);
      for (let i=start;i<=end;i++) {
        html += `<li class="page-item ${i===p.page?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
      }
      if (p.page < p.total_pages) html += `<li class="page-item"><a class="page-link" href="#" data-page="${p.page+1}">Next</a></li>`;
      ul.innerHTML = html;
      ul.querySelectorAll('a[data-page]').forEach(a=>a.addEventListener('click', e=>{ e.preventDefault(); loadCompanies(Number(a.dataset.page), currentFilters); }));
    }

    function renderCompanies(data) {
      const container = document.getElementById('companiesList');
      const companies = data.companies || [];
      if (!companies.length) { container.innerHTML = '<div class="col-12 text-center"><p>No companies found.</p></div>'; return; }
      container.innerHTML = companies.map(c => {
        const score = Number.isFinite(Number(c.attractiveness_score)) ? Math.round(Number(c.attractiveness_score)) : 'â€”';
        const tier = (c.investment_tier || '').toLowerCase();
        const tierBadge = tier.includes('tier 1')? 'ðŸŸ¢ Tier 1' : tier.includes('tier 2')? 'ðŸŸ¡ Tier 2' : tier.includes('tier 3')? 'ðŸŸ  Tier 3' : tier.includes('avoid')? 'ðŸ”´ Tier 4' : 'â€”';
        const valM = (Number(c.valuation_usd)||0)/1e6;
        return `
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">${c.company_name}</h5>
                <div class="text-muted small mb-1">${c.industry} â€¢ ${c.location}</div>
                <div class="small">${c.funding_round} â€¢ ${c.team_size} employees</div>
                <div class="mt-2 d-flex gap-2 align-items-center">
                  <span class="badge bg-secondary">Score: ${score}%</span>
                  <span class="badge bg-light text-dark border">${tierBadge}</span>
                </div>
                <div class="mt-2"><small class="text-muted">Valuation</small> <strong>$${valM.toFixed(1)}M</strong></div>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    async function loadCompanies(page=1, filters={}) {
      currentPage = page; currentFilters = filters;
      const listEl = document.getElementById('companiesList');
      listEl.innerHTML = `<div class=\"col-12 text-center\"><div class=\"spinner-border\"></div><p class=\"mt-2\">Loading companies...</p></div>`;
      const q = { page, per_page: 12 };
      if (filters.industry_group) q.industry_group = filters.industry_group; else if (filters.industry) q.industry = filters.industry;
      if (filters.region) q.region = filters.region; else if (filters.location) q.location = filters.location;
      if (filters.tier) q.tier = filters.tier;
      const url = apiUrl('/api/companies', q);
      if (inflight?.abort) inflight.abort();
      inflight = new AbortController();
      try {
        const res = await fetch(url, { signal: inflight.signal });
        const data = await res.json();
        updateFiltersUI(data.filters || {});
        updatePagination(data.pagination || {});
        renderCompanies(data);
      } catch (e) {
        listEl.innerHTML = `<div class=\"col-12 text-center text-danger\">Failed to load companies: ${e}</div>`;
      }
    }

    document.getElementById('searchBtn').addEventListener('click', ()=>{
      const i = document.getElementById('industryFilter').value;
      const r = document.getElementById('regionFilter').value;
      const t = document.getElementById('tierFilter').value;
      const f = {};
      if (i) f.industry_group = i;
      if (r) f.region = r;
      if (t) f.tier = t;
      loadCompanies(1, f);
    });

    // Initial load
    loadCompanies(1, {});
  </script>
</body>
</html>
